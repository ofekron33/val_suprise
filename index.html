<script>
  const zone = document.getElementById("zone");
  const yesBtn = document.getElementById("yesBtn");
  const noBtn = document.getElementById("noBtn");
  const result = document.getElementById("result");
  const hint = document.getElementById("hint");

  /* ---------- CONFETTI ---------- */
  const confettiCanvas = document.getElementById("confettiCanvas");

  function resizeConfettiCanvas() {
    const dpr = Math.max(1, window.devicePixelRatio || 1);
    confettiCanvas.width = Math.floor(window.innerWidth * dpr);
    confettiCanvas.height = Math.floor(window.innerHeight * dpr);
    confettiCanvas.style.width = "100vw";
    confettiCanvas.style.height = "100vh";
  }

  resizeConfettiCanvas();
  window.addEventListener("resize", resizeConfettiCanvas);
  window.addEventListener("orientationchange", () => setTimeout(resizeConfettiCanvas, 150));

  const confettiInstance = confetti.create(confettiCanvas, {
    resize: false,
    useWorker: true
  });

  function fullScreenConfetti() {
    const end = Date.now() + 1600;

    (function frame() {
      confettiInstance({
        particleCount: 12,
        spread: 90,
        startVelocity: 45,
        ticks: 180,
        origin: { x: Math.random(), y: Math.random() * 0.3 }
      });
      if (Date.now() < end) requestAnimationFrame(frame);
    })();

    setTimeout(() => {
      confettiInstance({
        particleCount: 300,
        spread: 140,
        startVelocity: 60,
        ticks: 220,
        origin: { x: 0.5, y: 0.55 }
      });
    }, 300);
  }

  /* ---------- YES BUTTON ---------- */
  let yesScale = 1;
  function growYes() {
    yesScale = Math.min(2.2, yesScale + 0.08);
    yesBtn.style.transform = `translateY(-50%) scale(${yesScale})`;
  }

  yesBtn.addEventListener("click", () => {
    zone.style.display = "none";
    hint.style.display = "none";
    result.style.display = "block";
    resizeConfettiCanvas();
    fullScreenConfetti();
  });

  /* ---------- NO BUTTON: SMART DODGE + ROTATING TEXT ---------- */
  const noTexts = [
    "No",
    "Care to reconsider?",
    "Third timeâ€™s a charm?",
    "Did you check my resume?",
    "Did you get a second opinion on my resume?",
    "Por favor ðŸ™",
    "Dime que sÃ­ ðŸ’–"
  ];

  let noIndex = 0;

  // Position in px relative to zone
  let noX = null;
  let noY = null;

  // Smooth gliding velocity
  let vx = 0;
  let vy = 0;

  const isTouch = window.matchMedia("(pointer: coarse)").matches;

  function clamp(n, min, max) {
    return Math.max(min, Math.min(max, n));
  }

  function initNoPositionIfNeeded() {
    if (noX !== null && noY !== null) return;

    const z = zone.getBoundingClientRect();
    const b = noBtn.getBoundingClientRect();

    noX = b.left - z.left;
    noY = b.top - z.top;

    // Force positioning via left/top
    noBtn.style.left = `${noX}px`;
    noBtn.style.top = `${noY}px`;
    noBtn.style.transform = "none";
  }

  function nextNoText() {
    noIndex = (noIndex + 1) % noTexts.length;
    noBtn.textContent = noTexts[noIndex];

    // Wiggle animation
    noBtn.animate(
      [
        { transform: "rotate(0deg) scale(1)" },
        { transform: "rotate(-5deg) scale(1.03)" },
        { transform: "rotate(4deg) scale(1.03)" },
        { transform: "rotate(0deg) scale(1)" }
      ],
      { duration: 220, easing: "ease-out" }
    );
  }

  function dodgeFromPointer(px, py) {
    initNoPositionIfNeeded();

    const z = zone.getBoundingClientRect();
    const b = noBtn.getBoundingClientRect();

    const cx = b.left + b.width / 2;
    const cy = b.top + b.height / 2;

    // Away vector (pointer -> center)
    let dx = cx - px;
    let dy = cy - py;

    let mag = Math.hypot(dx, dy);
    if (mag < 0.001) {
      dx = (Math.random() - 0.5);
      dy = (Math.random() - 0.5);
      mag = Math.hypot(dx, dy);
    }

    dx /= mag;
    dy /= mag;

    // Perpendicular spice
    const side = (Math.random() - 0.5) * 0.9;
    const ax = dx + (-dy) * side;
    const ay = dy + ( dx) * side;

    // Stronger as Yes grows
    const basePush = 130;
    const push = basePush + (yesScale - 1) * 35;

    // Accelerate into velocity (glide)
    vx += ax * push * 0.08;
    vy += ay * push * 0.08;

    // Cap speed
    const maxSpeed = 16;
    const speed = Math.hypot(vx, vy);
    if (speed > maxSpeed) {
      vx = (vx / speed) * maxSpeed;
      vy = (vy / speed) * maxSpeed;
    }

    // Apply movement
    noX += vx;
    noY += vy;

    // Damping
    vx *= 0.78;
    vy *= 0.78;

    // Clamp inside zone
    const maxX = z.width - b.width;
    const maxY = z.height - b.height;

    noX = clamp(noX, 0, maxX);
    noY = clamp(noY, 0, maxY);

    noBtn.style.left = `${noX}px`;
    noBtn.style.top = `${noY}px`;
  }

  let lastDodgeAt = 0;

  zone.addEventListener("pointermove", (e) => {
    initNoPositionIfNeeded();

    const b = noBtn.getBoundingClientRect();
    const cx = b.left + b.width / 2;
    const cy = b.top + b.height / 2;

    const d = Math.hypot(cx - e.clientX, cy - e.clientY);

    const triggerDist = isTouch ? 190 : 150;
    const now = performance.now();

    if (d < triggerDist) {
      dodgeFromPointer(e.clientX, e.clientY);

      // Throttle phrase changes + yes growth
      if (now - lastDodgeAt > 280) {
        nextNoText();
        growYes();
        lastDodgeAt = now;
      }
    }
  });

  // On tap/click: also dodge + rotate text (great for mobile)
  noBtn.addEventListener("pointerdown", (e) => {
    e.preventDefault();
    dodgeFromPointer(e.clientX, e.clientY);
    nextNoText();
    growYes();
  });

  // Prevent default click behavior (double safety)
  noBtn.addEventListener("click", (e) => e.preventDefault());
</script>
